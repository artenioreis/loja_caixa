{% extends "base.html" %}

{% block title %}PDV - Vendas - Sistema de Caixa{% endblock %}

{% block extra_css %}
<style>
    /* Estilo para a lista de itens da venda (carrinho) */
    .carrinho-lista {
        max-height: 400px;
        overflow-y: auto;
    }
    .total-display {
        background-color: #f8f9fa;
        border-radius: 5px;
        border: 1px solid #dee2e6;
    }
    /* Estilo para info do produto */
    #produto-info {
        min-height: 200px; /* Aumenta altura para caber a imagem */
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    #produto-info-img {
        max-height: 120px;
        max-width: 100%;
        object-fit: contain;
        margin-bottom: 10px;
    }

    /* ======================================================= */
    /* INÍCIO DO NOVO CSS (MODAL DE BUSCA)           */
    /* ======================================================= */
    #lista-resultados-busca {
        max-height: 400px;
        overflow-y: auto;
    }
    
    /* Estilo para o item da lista de busca */
    .resultado-item-busca img {
        width: 50px;
        height: 50px;
        object-fit: cover;
        margin-right: 15px;
        border-radius: 5px;
    }
    
    .resultado-item-busca .info {
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    
    .resultado-item-busca .info .nome {
        font-weight: bold;
        color: #0d6efd; /* Azul do Bootstrap */
    }
    
    .resultado-item-busca .info .detalhes {
        font-size: 0.85rem;
        color: #6c757d; /* Cinza do Bootstrap */
    }
    
    .resultado-item-busca .preco {
        font-size: 1.1rem;
        font-weight: bold;
        color: #198754; /* Verde do Bootstrap */
        white-space: nowrap; /* Impede que o preço quebre a linha */
    }
    /* ======================================================= */
    /* FIM DO NOVO CSS (MODAL DE BUSCA)            */
    /* ======================================================= */
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-shopping-cart"></i> PDV - Ponto de Venda</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <span class="badge bg-success fs-6">
            <i class="fas fa-lock-open"></i> Caixa Aberto (Saldo Inicial: R$ {{ "%.2f"|format(movimento_atual.saldo_inicial) }})
        </span>
    </div>
</div>

<div class="row">
    <div class="col-md-5">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-barcode"></i> Lançar Produto</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="codigo_barras" class="form-label">Código de Barras ou ID:</label>
                    <input type="text" class="form-control form-control-lg" id="codigo_barras" 
                           placeholder="Leia o código ou digite..." autofocus>
                </div>
                
                <div id="produto-info" class="text-center p-3 bg-light rounded">
                    <p class="text-muted">Aguardando produto...</p>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-6 mb-2">
                        <label for="quantidade" class="form-label">Quantidade:</label>
                        <input type="number" class="form-control" id="quantidade" value="1" min="1">
                    </div>
                    <div class="col-md-6 d-grid align-items-end">
                        <button class="btn btn-primary" id="btn-adicionar">
                            <i class="fas fa-plus"></i> Adicionar (Enter)
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-body">
                <h6 class="card-title">Atalhos</h6>
                <p><kbd>Enter</kbd> - Adicionar Item</p>
                <p><kbd>F2</kbd> - Buscar Produto por Nome</p>
                <p><kbd>F6</kbd> - Finalizar Venda</p>
                <p><kbd>F3</kbd> - Cancelar Venda</p>
            </div>
        </div>
    </div>

    <div class="col-md-7">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-list-ul"></i> Itens da Venda</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive carrinho-lista">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">Produto</th>
                                <th scope="col">Qtd.</th>
                                <th scope="col">Vl. Unit.</th>
                                <th scope="col">Subtotal</th>
                                <th scope="col">Ação</th>
                            </tr>
                        </thead>
                        <tbody id="carrinho-tbody">
                            </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer">
                <div class="row total-display p-3 align-items-center">
                    <div class="col-md-6">
                        <h4>Total de Itens: <span id="total-itens" class="fw-bold">0</span></h4>
                    </div>
                    <div class="col-md-6 text-end">
                        <h2 class="mb-0">Total: <span id="total-venda" class="fw-bold text-success">R$ 0.00</span></h2>
                    </div>
                </div>
                <div class="d-grid gap-2 mt-3">
                    <button class="btn btn-success btn-lg" id="btn-finalizar" data-bs-toggle="modal" data-bs-target="#modalFinalizar">
                        <i class="fas fa-check"></i> Finalizar Venda (F6)
                    </button>
                    <button class="btn btn-danger" id="btn-cancelar">
                        <i class="fas fa-times"></i> Cancelar Venda (F3)
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalBuscarProduto" tabindex="-1" aria-labelledby="modalBuscarProdutoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalBuscarProdutoLabel"><i class="fas fa-search"></i> Buscar Produto por Nome</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="input-busca-nome" class="form-label">Digite o nome ou código do produto:</label>
                    <input type="text" class="form-control form-control-lg" id="input-busca-nome" placeholder="Ex: Arroz ou 789...">
                </div>
                <hr>
                <div id="lista-resultados-busca">
                    <p class="text-center text-muted">Aguardando digitação (mín. 2 caracteres)...</p>
                    </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="modalFinalizar" tabindex="-1" aria-labelledby="modalFinalizarLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="modalFinalizarLabel"><i class="fas fa-check"></i> Finalizar Venda</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="forma_pagamento" class="form-label">Forma de Pagamento:</label>
                            <select class="form-select form-select-lg" id="forma_pagamento">
                                <option value="dinheiro">Dinheiro</option>
                                <option value="cartao">Cartão</option>
                                <option value="pix">PIX</option>
                            </select>
                        </div>
                        
                        <div class="mb-3" id="campo-valor-pago">
                            <label for="valor_pago" class="form-label">Valor Pago (R$):</label>
                            <input type="number" step="0.01" class="form-control form-control-lg" id="valor_pago" placeholder="0.00">
                        </div>
                        
                        <div class="mb-3 text-center" id="campo-pix-qrcode" style="display: none;">
                            <label class="form-label fw-bold">Pague com PIX</label>
                            <p class="text-muted" style="font-size: 0.9rem;">
                                Aponte a câmera para o QR Code e digite o valor total (R$ <span id="modal-total-pix">0.00</span>).
                            </p>
                            
                            <img src="{{ url_for('static', filename='images/qrcode_pix_loja.png') }}" 
                                 alt="QR Code PIX da Loja" 
                                 class="img-fluid rounded border" 
                                 style="max-width: 250px;">
                        </div>
                    </div>
                    
                    <div class="col-md-6 bg-light p-4 rounded">
                        <h3>Total a Pagar:</h3>
                        <h1 id="modal-total-venda" class="display-5 fw-bold text-success">R$ 0.00</h1>
                        <hr>
                        <h3>Troco:</h3>
                        <h1 id="modal-troco" class="display-6 fw-bold text-primary">R$ 0.00</h1>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Voltar</button>
                <button type="button" class="btn btn-success btn-lg" id="btn-confirmar-venda">
                    <i class="fas fa-save"></i> Confirmar Venda
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // =========================================================================
    // VARIÁVEIS DE ESTADO
    // =========================================================================
    let carrinho = []; // Armazena os itens da venda ( [{id, nome, preco, qtd, subtotal}, ...] )
    let produtoAtual = null; // Armazena o último produto buscado
    
    // =========================================================================
    // ELEMENTOS DOM
    // =========================================================================
    const inputCodigoBarras = document.getElementById('codigo_barras');
    const inputQuantidade = document.getElementById('quantidade');
    const btnAdicionar = document.getElementById('btn-adicionar');
    const infoProdutoDiv = document.getElementById('produto-info');
    const carrinhoTbody = document.getElementById('carrinho-tbody');
    const totalItensSpan = document.getElementById('total-itens');
    const totalVendaSpan = document.getElementById('total-venda');
    const btnFinalizar = document.getElementById('btn-finalizar');
    const btnCancelar = document.getElementById('btn-cancelar');
    
    // --- Modal Finalizar (Existente) ---
    const modalFinalizarVenda = new bootstrap.Modal(document.getElementById('modalFinalizar'));
    const modalTotalVenda = document.getElementById('modal-total-venda');
    const modalTroco = document.getElementById('modal-troco');
    const selectFormaPagamento = document.getElementById('forma_pagamento');
    const inputValorPago = document.getElementById('valor_pago');
    const campoValorPago = document.getElementById('campo-valor-pago');
    const btnConfirmarVenda = document.getElementById('btn-confirmar-venda');
    
    // --- Elementos PIX (Existente) ---
    const campoPixQrcode = document.getElementById('campo-pix-qrcode');
    const modalTotalPix = document.getElementById('modal-total-pix');

    // =========================================================================
    //           INÍCIO DOS NOVOS ELEMENTOS (MODAL DE BUSCA)
    // =========================================================================
    const modalBusca = new bootstrap.Modal(document.getElementById('modalBuscarProduto'));
    const inputBuscaNome = document.getElementById('input-busca-nome');
    const listaResultadosBusca = document.getElementById('lista-resultados-busca');
    let buscaTypingTimer; // Timer para o debounce da busca por nome
    // =========================================================================
    //             FIM DOS NOVOS ELEMENTOS
    // =========================================================================

    // =========================================================================
    // FUNÇÕES PRINCIPAIS
    // =========================================================================

    /**
     * Busca o produto na API do backend
     */
    async function buscarProduto(forceSearch = false) {
        const codigo = inputCodigoBarras.value;

        // Adiciona uma verificação para código vazio
        if (codigo.length === 0) {
            limparInfoProduto();
            return;
        }

        try {
            const response = await fetch(`/api/produto/${codigo}`);
            
            if (!response.ok) {
                const error = await response.json();
                infoProdutoDiv.innerHTML = `<p class="text-danger fw-bold">${error.error}</p>`;
                produtoAtual = null;
                return;
            }

            const produto = await response.json();
            produtoAtual = produto; // Armazena o produto encontrado
            
            // --- ATUALIZAÇÃO PARA MOSTRAR IMAGEM ---
            let img_html = '';
            if (produto.imagem_url) {
                // A API agora retorna a URL completa
                img_html = `<img src="${produto.imagem_url}" alt="${produto.nome}" id="produto-info-img">`;
            } else {
                img_html = '<i class="fas fa-image fa-3x text-muted mb-2"></i>';
            }
            
            // Atualiza o painel de informações
            infoProdutoDiv.innerHTML = `
                ${img_html}
                <h5 class="text-primary mb-0">${produto.nome}</h5>
                <h3 class="fw-bold">R$ ${produto.preco_venda.toFixed(2)}</h3>
                <small class="text-muted">Estoque: ${produto.estoque_atual}</small>
            `;
            // ----------------------------------------
            
            // Foca na quantidade para o usuário confirmar
            inputQuantidade.focus();
            inputQuantidade.select();

        } catch (error) {
            console.error('Erro ao buscar produto:', error);
            infoProdutoDiv.innerHTML = `<p class="text-danger">Erro de conexão.</p>`;
            produtoAtual = null;
        }
    }
    
    /**
     * Adiciona o produto_atual ao carrinho
     */
    function adicionarAoCarrinho() {
        if (!produtoAtual) {
            alert('Nenhum produto selecionado. Busque um produto primeiro.');
            inputCodigoBarras.focus();
            return;
        }

        const quantidade = parseInt(inputQuantidade.value);
        if (isNaN(quantidade) || quantidade <= 0) {
            alert('Quantidade inválida.');
            return;
        }

        // Verifica se o item já está no carrinho
        const itemExistente = carrinho.find(item => item.id === produtoAtual.id);

        if (itemExistente) {
            // Apenas atualiza a quantidade
            itemExistente.qtd += quantidade;
            itemExistente.subtotal = itemExistente.preco * itemExistente.qtd;
        } else {
            // Adiciona novo item
            carrinho.push({
                id: produtoAtual.id,
                nome: produtoAtual.nome,
                preco: produtoAtual.preco_venda,
                qtd: quantidade,
                subtotal: produtoAtual.preco_venda * quantidade
            });
        }
        
        renderizarCarrinho();
        limparFormularioProduto();
    }
    
    /**
     * Redesenha a tabela do carrinho e os totais (COM INPUT EDITÁVEL)
     */
    function renderizarCarrinho() {
        carrinhoTbody.innerHTML = ''; // Limpa a tabela
        
        let totalVenda = 0;
        let totalItens = 0;

        carrinho.forEach((item, index) => {
            totalVenda += item.subtotal;
            totalItens += item.qtd;

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${index + 1}</td>
                <td>${item.nome}</td>
                <td style="width: 100px;">
                    <input type="number" 
                           class="form-control form-control-sm text-center" 
                           value="${item.qtd}" 
                           min="1" 
                           onchange="atualizarQuantidadeItem(${item.id}, this.value)">
                </td>
                <td>R$ ${item.preco.toFixed(2)}</td>
                <td>R$ ${item.subtotal.toFixed(2)}</td>
                <td>
                    <button class="btn btn-danger btn-sm" onclick="removerItemCarrinho(${item.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            carrinhoTbody.appendChild(tr);
        });

        // Atualiza os totais
        totalItensSpan.textContent = totalItens;
        totalVendaSpan.textContent = `R$ ${totalVenda.toFixed(2)}`;
        
        // Atualiza o modal
        modalTotalVenda.textContent = `R$ ${totalVenda.toFixed(2)}`;
        
        // Habilita/desabilita botão de finalizar
        btnFinalizar.disabled = carrinho.length === 0;
    }

    /**
     * Atualiza a quantidade de um item já existente no carrinho
     */
    window.atualizarQuantidadeItem = function(produtoId, novaQuantidade) {
        const qtd = parseInt(novaQuantidade);
        
        // Validação básica
        if (isNaN(qtd) || qtd <= 0) {
            alert("A quantidade deve ser maior que zero.");
            renderizarCarrinho(); // Restaura o valor antigo na tela
            return;
        }

        // Encontra o item no array do carrinho
        const item = carrinho.find(item => item.id === produtoId);

        if (item) {
            // Atualiza quantidade e recalcula subtotal
            item.qtd = qtd;
            item.subtotal = item.preco * item.qtd;
            
            // Atualiza a interface
            renderizarCarrinho();
        }
    };
    
    /**
     * Remove um item do carrinho
     */
    window.removerItemCarrinho = function(produtoId) {
        carrinho = carrinho.filter(item => item.id !== produtoId);
        renderizarCarrinho();
    }
    
    /**
     * Limpa o formulário de busca de produto
     */
    function limparFormularioProduto() {
        produtoAtual = null;
        inputCodigoBarras.value = '';
        inputQuantidade.value = '1';
        infoProdutoDiv.innerHTML = '<p class="text-muted">Aguardando produto...</p>';
        inputCodigoBarras.focus();
    }
    
    /**
     * Limpa toda a venda
     */
    function cancelarVenda() {
        if (carrinho.length > 0 && confirm('Tem certeza que deseja cancelar a venda atual?')) {
            carrinho = [];
            renderizarCarrinho();
            limparFormularioProduto();
        }
    }
    
    /**
     * Lógica do modal de finalização (FUNÇÃO ATUALIZADA COM PIX)
     */
    function atualizarModalPagamento() {
        const totalVenda = parseFloat(carrinho.reduce((acc, item) => acc + item.subtotal, 0));
        const valorPago = parseFloat(inputValorPago.value) || 0;
        
        let troco = 0;
        
        // Atualiza o valor total no modal (para ambos os lados)
        modalTotalVenda.textContent = `R$ ${totalVenda.toFixed(2)}`; // ATUALIZADO
        modalTotalPix.textContent = totalVenda.toFixed(2);
        
        // Esconde ambos os campos dinâmicos por padrão
        campoValorPago.style.display = 'none';
        campoPixQrcode.style.display = 'none';
        
        // Verifica a forma de pagamento selecionada
        if (selectFormaPagamento.value === 'dinheiro') {
            campoValorPago.style.display = 'block'; // Mostra campo "Valor Pago"
            if (valorPago > 0) {
                 troco = valorPago - totalVenda;
            }
        
        } else if (selectFormaPagamento.value === 'pix') {
            campoPixQrcode.style.display = 'block'; // Mostra campo "QR Code"
            // Se for PIX, o valor pago é o total da venda e não há troco
            inputValorPago.value = totalVenda.toFixed(2);
            troco = 0;
        
        } else {
            // 'cartao' ou outro
            // Se for cartão, o valor pago é o total da venda e não há troco
            inputValorPago.value = totalVenda.toFixed(2);
            troco = 0;
        }
        
        modalTroco.textContent = `R$ ${troco.toFixed(2)}`;
        
        if (troco < 0) {
            modalTroco.classList.add('text-danger');
            modalTroco.classList.remove('text-primary');
        } else {
            modalTroco.classList.remove('text-danger');
            modalTroco.classList.add('text-primary');
        }
    }
    
    /**
     * Envia os dados da venda para o backend
     */
    async function finalizarVenda() {
        const totalVenda = carrinho.reduce((acc, item) => acc + item.subtotal, 0);
        const valorPago = parseFloat(inputValorPago.value);
        const formaPagamento = selectFormaPagamento.value;

        if (formaPagamento === 'dinheiro' && valorPago < totalVenda) {
            alert('Valor pago é menor que o total da venda.');
            return;
        }

        // Prepara os dados para enviar
        const dadosVenda = {
            itens: carrinho.map(item => ({ id: item.id, quantidade: item.qtd })),
            forma_pagamento: formaPagamento,
            valor_pago: valorPago
        };
        
        btnConfirmarVenda.disabled = true;
        btnConfirmarVenda.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';

        try {
            const response = await fetch('/vendas/finalizar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(dadosVenda)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Erro desconhecido');
            }

            const result = await response.json();
            
            // Abrir o cupom em nova janela
            window.open('/venda/cupom/' + result.venda_id, '_blank', 'width=500,height=700');
            
            // Limpa tudo
            carrinho = [];
            renderizarCarrinho();
            limparFormularioProduto();
            modalFinalizarVenda.hide(); // CORRIGIDO

        } catch (error) {
            console.error('Erro ao finalizar venda:', error);
            alert(`Erro: ${error.message}`);
        } finally {
            btnConfirmarVenda.disabled = false;
            btnConfirmarVenda.innerHTML = '<i class="fas fa-save"></i> Confirmar Venda';
        }
    }

    
    // =========================================================================
    //           INÍCIO DAS NOVAS FUNÇÕES (BUSCA POR NOME)
    // =========================================================================

    /**
     * Busca produtos por nome na nova API
     */
    async function buscarProdutoPorNome() {
        const termo = inputBuscaNome.value;

        if (termo.length < 2) {
            listaResultadosBusca.innerHTML = '<p class="text-center text-muted">Aguardando digitação (mín. 2 caracteres)...</p>';
            return;
        }

        listaResultadosBusca.innerHTML = '<p class="text-center text-primary"><i class="fas fa-spinner fa-spin"></i> Buscando...</p>';

        try {
            // Chama a nova API criada no app.py
            const response = await fetch(`/api/produtos/buscar?nome=${termo}`);
            if (!response.ok) {
                throw new Error('Erro ao buscar produtos');
            }
            const produtos = await response.json();
            renderizarResultadosBusca(produtos);
        } catch (error) {
            console.error('Erro na busca por nome:', error);
            listaResultadosBusca.innerHTML = '<p class="text-center text-danger">Erro ao buscar produtos.</p>';
        }
    }

    /**
     * Renderiza os resultados da busca por nome no modal
     */
    function renderizarResultadosBusca(produtos) {
        listaResultadosBusca.innerHTML = ''; // Limpa a lista

        if (produtos.length === 0) {
            listaResultadosBusca.innerHTML = '<p class="text-center text-warning">Nenhum produto encontrado.</p>';
            return;
        }

        const ul = document.createElement('ul');
        ul.className = 'list-group';

        produtos.forEach(produto => {
            const li = document.createElement('a'); // Usamos <a> para ser clicável
            li.href = "#";
            li.className = 'list-group-item list-group-item-action resultado-item-busca d-flex justify-content-between align-items-center';
            
            // Armazena todos os dados do produto no próprio elemento
            li.dataset.produtoJson = JSON.stringify(produto);
            
            // Imagem (ou ícone)
            const imgHtml = produto.imagem_url
                ? `<img src="${produto.imagem_url}" alt="${produto.nome}">`
                : `<div class="d-flex align-items-center justify-content-center" style="width: 50px; height: 50px; background: #eee; margin-right: 15px; border-radius: 5px;"><i class="fas fa-image text-muted"></i></div>`;

            // Informações (Nome, Estoque)
            const infoHtml = `
                <div class="info">
                    <span class="nome">${produto.nome}</span>
                    <span class="detalhes">Cód: ${produto.codigo_barras} | Estoque: ${produto.estoque_atual}</span>
                </div>
            `;
            
            // Preço
            const precoHtml = `<span class="preco">R$ ${produto.preco_venda.toFixed(2)}</span>`;

            li.innerHTML = `
                <div class="d-flex align-items-center">
                    ${imgHtml}
                    ${infoHtml}
                </div>
                ${precoHtml}
            `;
            
            // Adiciona o evento de clique
            li.addEventListener('click', selecionarProdutoDaBusca);
            
            ul.appendChild(li);
        });
        
        listaResultadosBusca.appendChild(ul);
    }

    /**
     * Ação ao clicar em um item da lista de busca
     */
    function selecionarProdutoDaBusca(e) {
        e.preventDefault();
        
        // Pega os dados do produto que armazenamos no 'dataset'
        const produto = JSON.parse(e.currentTarget.dataset.produtoJson);

        // 1. Define o 'produtoAtual' (variável global)
        // A função adicionarAoCarrinho usa 'produtoAtual'
        produtoAtual = {
            id: produto.id,
            nome: produto.nome,
            preco_venda: produto.preco_venda
            // os outros campos não são necessários para adicionarAoCarrinho
        };
        
        // 2. Chama a função de adicionar ao carrinho
        // O input 'quantidade' (que está fora do modal) será usado (padrão 1)
        adicionarAoCarrinho();
        
        // 3. Fecha o modal
        modalBusca.hide();
    }
    
    // =========================================================================
    //           FIM DAS NOVAS FUNÇÕES
    // =========================================================================


    // =========================================================================
    // EVENT LISTENERS
    // =========================================================================

    // Busca produto ao digitar (com delay)
    let typingTimer;
    inputCodigoBarras.addEventListener('keyup', (e) => {
        clearTimeout(typingTimer);
        // Se pressionar Enter, busca e tenta adicionar imediatamente
        if (e.key === 'Enter') {
            // Passa true para forçar a busca
            buscarProduto(true).then(() => {
                if(produtoAtual) {
                    adicionarAoCarrinho();
                }
            });
        } else {
             // Caso contrário, espera o usuário parar de digitar
             typingTimer = setTimeout(() => {
                buscarProduto(false); 
             }, 500); // 500ms delay
        }
    });
    
    // Adicionar com botão
    btnAdicionar.addEventListener('click', adicionarAoCarrinho);
    
    // Adicionar com Enter no campo quantidade
    inputQuantidade.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            adicionarAoCarrinho(); // CORRIGIDO (era adicionarAoVenda)
        }
    });
    
    // Botões de ação
    btnCancelar.addEventListener('click', cancelarVenda);
    btnConfirmarVenda.addEventListener('click', finalizarVenda);
    
    // Listeners do Modal
    selectFormaPagamento.addEventListener('change', atualizarModalPagamento);
    inputValorPago.addEventListener('input', atualizarModalPagamento);
    
    // Atalhos do teclado (MODIFICADO)
    document.addEventListener('keydown', (e) => {
        
        // ======================================================= //
        //           INÍCIO DA NOVA LÓGICA (F2)                    //
        // ======================================================= //
        if (e.key === 'F2') {
            e.preventDefault();
            modalBusca.show();
        }
        // ======================================================= //
        
        if (e.key === 'F6') {
            e.preventDefault();
            if(carrinho.length > 0) {
                atualizarModalPagamento(); 
                modalFinalizarVenda.show(); // CORRIGIDO (era modal.show())
            }
        }
        if (e.key === 'F3') {
            e.preventDefault();
            cancelarVenda();
        }
    });

    // =========================================================================
    //           INÍCIO DOS NOVOS LISTENERS (MODAL DE BUSCA)
    // =========================================================================
    
    // Foca o input de busca quando o modal abrir
    document.getElementById('modalBuscarProduto').addEventListener('shown.bs.modal', function () {
        inputBuscaNome.focus();
        inputBuscaNome.select();
    });
    
    // Limpa o input de busca quando o modal fechar
    document.getElementById('modalBuscarProduto').addEventListener('hidden.bs.modal', function () {
        inputBuscaNome.value = '';
        listaResultadosBusca.innerHTML = '<p class="text-center text-muted">Aguardando digitação (mín. 2 caracteres)...</p>';
    });

    // Evento de digitação no input de busca (com debounce)
    inputBuscaNome.addEventListener('keyup', (e) => {
        clearTimeout(buscaTypingTimer);
        
        // Se o usuário pressionar Enter na busca, não faz nada (ele deve clicar)
        if (e.key === 'Enter') {
            e.preventDefault();
            return;
        }
        
        buscaTypingTimer = setTimeout(buscarProdutoPorNome, 300); // 300ms de espera
    });
    // =========================================================================
    //           FIM DOS NOVOS LISTENERS
    // =========================================================================

    // Inicializa a tela
    renderizarCarrinho();
    limparFormularioProduto();
});
</script>
{% endblock %}